dist: xenial
language: java
java:
- openjdk11
sudo: false
cache:
  directories:
  - "$HOME/.m2"
  - "$HOME/.cache/yarn"
before_install:
- nvm install '12'
install: true
before_script:
- yarn global add @conveyal/maven-semantic-release semantic-release@15
script:
- mvn package
after_success:
- bash <(curl -s https://codecov.io/bash) -s target-unit-test-results -F unit_tests
- |
  semantic-release --prepare @conveyal/maven-semantic-release --publish @semantic-release/github,@conveyal/maven-semantic-release --verify-conditions @semantic-release/github,@conveyal/maven-semantic-release --verify-release @conveyal/maven-semantic-release --use-conveyal-workflow --dev-branch=dev --skip-maven-deploy
  if [[ "$TRAVIS_BRANCH" = "master" ]]; then
    bash <(curl -s https://codecov.io/bash) -C "$(git rev-parse HEAD)" -s target-unit-test-results -F unit_tests
    bash <(curl -s https://codecov.io/bash) -C "$(git rev-parse HEAD^)" -s target-unit-test-results -F unit_tests
  fi
before_deploy:
- export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH;
  else echo $TRAVIS_PULL_REQUEST_BRANCH; fi)
- export BRANCH_CLEAN=${BRANCH//\//_}
- mkdir deploy
- ls target/*.jar
- cp target/otp-middleware-*.jar deploy/
- cp target/otp-middleware-*.jar "deploy/otp-middleware-latest-BRANCH_CLEAN.jar"
deploy:
  provider: s3
  skip_cleanup: true
  access_key_id: AKIA2YG5XQ2YJDTPRQ7Z
  secret_access_key:
    secure: qT2Iz8EcYQolxULMmkX1IRtE9ywEjwP1qaViJnxbsST9GLg/lwvDj+XoeM6y6kwbcXe3PUm9OsHRCADon0jINKUR6VgiZvhBjh5SmxywKJackVzP546wHepCe2+uJKEuwILttqZ2/vpxKCLIdSwDPLCc349e5VlI9Zel8coBALctP+OEd2UIsBSS7TXG4WtIkGjEAxhgrzjftx8vG+aRw58OplYs2bRbtw9ybqvjdGELdsDnNiitXXMRwUUyazahK6H01kJnhbXV9+PmUVT3KYVQ9RgB6OhpRk2iPl0gPQFi7mominb8xPK/DEtGJa7jL3eX7hr/IN5teEPv9DtmvRA+JerBuz38PwFuxybQ8bQKhNpfvbV6RghFKcCLj8qs8yRfzx43MoHQC3LsPCyXppGXcofsBlK7RcbQWQDOJkNZABe2awKINDUCQpYFnUkD0seN6xT0d1UK1jz9ucymls+2lZNz1Pc2oh1V5tMRL13uNQfsdaH8tWo6llljLNS0ndPn8UzUckg/vWMPwvmwBD9Aju29ImkSxXF9rW5a6NP+vNOqiUrs1ZStMHjSURaxI2upxmfowT2bxY81ZysEjssKJ4LBseKpi7TOuY8Wki5BLk4uaLt5b4wHZIsHWtQKoAP4i37A8QwNrzf7OLHI+Xc1s2UwAEE9t5Up173J1lA=
  bucket: otp-middleware-builds
  local-dir: deploy
  acl: public_read
  on:
    repo: ibi-group/otp-middleware
    all_branches: true
